#!/usr/bin/env python3

import os
import shutil
import sys
import re
import subprocess

BOILERPLATE_PATH = "/Users/maty/Projects/boilerplate/"
REPLACE_PATTERN = "boilerplate"
EXCLUDE = {".git", "node_modules", ".next", ".DS_Store"}


class NewApp:
    def __init__(self, src=BOILERPLATE_PATH):
        self.src = src
        self.app_name = ""
        self.dst = ""

    def copy_boilerplate(self, exclude=EXCLUDE):
        for root, dirs, files in os.walk(self.src):
            rel_path = os.path.relpath(root, self.src)
            if rel_path == ".":
                rel_path = ""
            target_root = os.path.join(self.dst, rel_path)
            dirs[:] = [d for d in dirs if d not in exclude]
            if not os.path.exists(target_root):
                os.makedirs(target_root)
            for file in files:
                if file in exclude:
                    continue
                shutil.copy2(os.path.join(root, file), os.path.join(target_root, file))

    def replace_in_files(self):
        pattern = re.compile(REPLACE_PATTERN, re.IGNORECASE)
        for root, _, files in os.walk(self.dst):
            for file in files:
                file_path = os.path.join(root, file)
                try:
                    with open(file_path, "r", encoding="utf-8", errors="ignore") as f:
                        content = f.read()

                    def repl(match):
                        t = match.group(0)
                        if t.isupper():
                            return self.app_name.upper()
                        if t[0].isupper():
                            return self.app_name.capitalize()
                        return self.app_name

                    new_content = pattern.sub(repl, content)
                    if new_content != content:
                        with open(file_path, "w", encoding="utf-8") as f:
                            f.write(new_content)
                except Exception:
                    pass

    def git_init_commit(self):
        try:
            subprocess.run(
                ["git", "init"],
                cwd=self.dst,
                check=True,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
            )
            subprocess.run(
                ["git", "add", "-A"],
                cwd=self.dst,
                check=True,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
            )
            subprocess.run(
                ["git", "commit", "-m", f"Initial commit for {self.app_name} project"],
                cwd=self.dst,
                check=True,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
            )
        except Exception:
            pass

    def pnpm_install(self):
        try:
            subprocess.run(["pnpm", "i"], cwd=self.dst, check=True)
        except Exception:
            pass

    def get_app_name(self):
        while True:
            self.app_name = input(
                "Enter the name of your app (lowercase only): "
            ).strip()
            if not self.app_name:
                print("App name cannot be empty.")
                continue
            if not self.app_name.islower():
                print("App name must be only lowercase.")
                continue
            break
        self.dst = os.path.join(os.getcwd(), self.app_name)

    def setup(self):
        self.get_app_name()
        if not os.path.exists(self.src):
            print(f"Source boilerplate not found: {self.src}")
            sys.exit(1)
        if os.path.exists(self.dst):
            print(f"Target directory already exists: {self.dst}")
            sys.exit(1)
        self.copy_boilerplate()
        self.replace_in_files()
        self.git_init_commit()
        self.pnpm_install()


def main():
    NewApp().setup()


if __name__ == "__main__":
    main()
